# ================================================================
# 基本設定ファイル（PPO環境再設計版）
# システムの動作に必要な基本設定を記載
# ================================================================

# ================================================================
# 実験基本設定（デフォルト値）
# ================================================================
experiment:
  name: "ems_ppo"
  description: "救急車配車最適化"
  seed: 42
  device: "cuda"  # "cpu" or "cuda"

# ================================================================
# 状態空間エンコーディング設定（46次元）
# ================================================================
state_encoding:
  # モード選択
  # - 'full': 従来の999次元（192台×5特徴量 + 事案10 + 時間8 + 空間21）
  # - 'compact': 新46次元（候補隊40 + グローバル5 + 傷病度1）
  mode: 'compact'
  
  # Top-K設定（compactモード時）
  top_k: 10  # 考慮する上位救急車数
  
  # 正規化パラメータ
  normalization:
    max_travel_time_minutes: 30   # 移動時間の上限（これを1.0とする）
    max_station_distance_km: 10   # 署距離の上限（これを1.0とする）

# ================================================================
# データ基本設定
# ================================================================
data:
  # データパス（システム必須）
  data_paths:
    grid_mapping: "data/tokyo/processed/grid_mapping_res9.json"
    travel_time_matrix: "data/tokyo/calibration2/linear_calibrated_response.npy"
  
  # シミュレーション設定
  episode_duration_hours: 24

  # デイタイム救急を除外（ValidationSimulatorと一致）
  exclude_daytime_ambulances: true

  # デフォルトのエリア設定（個別設定で上書き）
  area_restriction:
    enabled: false
    area_name: "default"
    districts: []
    num_ambulances_in_area: 192
  
  # デフォルト期間（個別設定で上書き）
  train_periods:
    - start_date: "20230401"
      end_date: "20230430"
  eval_periods:
    - start_date: "20230501"
      end_date: "20230507"

# ================================================================
# PPO設定
# ================================================================
ppo:
  n_episodes: 5000
  batch_size: 1024
  n_epochs: 6
  clip_epsilon: 0.1
  
  learning_rate:
    actor: 0.0003
    critic: 0.001
    scheduler: "constant"
  
  gamma: 0.99
  gae_lambda: 0.95
  entropy_coef: 0.015
  max_grad_norm: 0.5

# ================================================================
# 報酬システム設定（統一版）
# ================================================================
reward:
  # システムレベル（環境の基本動作）
  system:
    dispatch_failure: -1.0
    no_available_ambulance: 0.0
  
  # 統一報酬パラメータ（新設計）
  unified:
    # 重症系パラメータ（通常PPO用、論文5章の設計）
    critical_max_bonus: 50.0
    critical_lambda: 0.115
    critical_penalty_scale: 5.0
    critical_penalty_power: 1.5
    
    # 軽症系パラメータ（論文5章の設計）
    mild_max_bonus: 10.0
    mild_penalty_scale: 1.0
    
    # カバレッジパラメータ
    coverage_w6: 0.5       # L6の重み
    coverage_w13: 0.5      # L13の重み
    coverage_penalty_scale: 10.0  # カバレッジ損失のペナルティスケール
    
    # 重み配分（傷病度考慮運用と同じ）
    time_weight: 0.6
    coverage_weight: 0.4

# ================================================================
# ネットワーク構造（46次元に最適化）
# ================================================================
network:
  actor:
    hidden_layers: [128, 64]  # 入力次元（46）に対して適切なサイズ
    activation: "relu"
    initialization: "xavier_uniform"
    dropout: 0.2
  
  critic:
    hidden_layers: [128, 64]
    activation: "relu"
    init_scale: 0.001
    dropout: 0.2

# ================================================================
# 学習管理
# ================================================================
training:
  checkpoint_interval: 250
  keep_last_n: 5
  
  early_stopping:
    enabled: true
    patience: 500
    min_delta: 0.001
  
  logging:
    interval: 10
    tensorboard: true
    wandb: true

# ================================================================
# 評価設定
# ================================================================
evaluation:
  interval: 100
  n_eval_episodes: 10
  compare_baselines: ["closest"]
  metrics:
    - "critical_6min_rate"
    - "achieved_13min_rate"
    - "mean_response_time"
    - "vs_closest_improvement"

# ================================================================
# ハイブリッドモード設定
# ================================================================
hybrid_mode:
  enabled: false  # true: ハイブリッドPPO, false: 通常PPO
  severity_classification:
    severe_conditions: ["重症", "重篤", "死亡"]
    mild_conditions: ["軽症", "中等症"]
