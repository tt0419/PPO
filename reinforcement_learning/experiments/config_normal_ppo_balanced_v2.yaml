# ================================================================
# 通常PPO 本格学習設定 v2
# バランス版 - 全傷病度でPPO学習（ハイブリッドなし）
# ================================================================

# ベース設定を継承
inherits: ./config.yaml

# ================================================================
# 実験設定
# ================================================================
experiment:
  name: "normal_ppo_balanced_v2"
  description: |
    46次元設計の通常PPO本格学習（バランス版）
    
    ハイブリッド版との違い:
    - 重症系もPPOが選択（直近隊固定ではない）
    - 重症系には6分達成を重視した報酬（指数/べき乗型）
    
    ハイブリッドv2の感触が良いため、同様のバランスを採用:
    - time 50% / coverage 50%
    - coverage_penalty_scale: 20.0
    
    目標:
    - 直近隊選択率: 60-80%
    - 13分達成率: 85%以上
    - 重症系6分達成率: 直近隊運用と同等
  seed: 2025
  device: "cuda"

# ================================================================
# PPO設定（本格学習用）
# ================================================================
ppo:
  n_episodes: 3000  # 本格学習
  batch_size: 512
  n_epochs: 4
  clip_epsilon: 0.1
  
  learning_rate:
    actor: 0.0003
    critic: 0.001
    scheduler: "constant"
  
  gamma: 0.99
  gae_lambda: 0.95
  
  # 探索（v2と同等）
  entropy_coef: 0.025
  
  max_grad_norm: 0.5

# ================================================================
# 状態空間（46次元）
# ================================================================
state_encoding:
  mode: 'compact'
  top_k: 10
  normalization:
    max_travel_time_minutes: 30
    max_station_distance_km: 10

# ================================================================
# ★★★ ハイブリッドモード無効 ★★★
# 重症系も軽症系もPPOが選択
# ================================================================
hybrid_mode:
  enabled: false

# ================================================================
# 報酬設定（通常PPO バランス版）
# ★★★ 重症系の報酬も使用される ★★★
# ================================================================
reward:
  system:
    dispatch_failure: -1.0
    no_available_ambulance: 0.0
  
  unified:
    # ★★★ 重症系パラメータ（6分達成を最優先） ★★★
    # 指数/べき乗型報酬：6分以内で大きなボーナス、超過で急激なペナルティ
    critical_max_bonus: 50.0      # 6分達成時の最大ボーナス
    critical_lambda: 0.115        # 指数減衰パラメータ
    critical_penalty_scale: 8.0   # 超過ペナルティ（少し強め）
    critical_penalty_power: 1.5   # べき乗（超過時間に応じて急増）
    
    # 軽症系パラメータ
    mild_max_bonus: 10.0
    mild_penalty_scale: 1.0
    
    # ★★★ カバレッジパラメータ（v2と同等） ★★★
    coverage_w6: 1.0
    coverage_w13: 0.0
    coverage_penalty_scale: 20.0
    
    # ★★★ 重み配分（バランス） ★★★
    time_weight: 0.5
    coverage_weight: 0.5

# ================================================================
# ネットワーク設定
# ================================================================
network:
  actor:
    hidden_layers: [128, 64]
    activation: "relu"
    dropout: 0.2
  
  critic:
    hidden_layers: [128, 64]
    activation: "relu"
    dropout: 0.2

# ================================================================
# 学習管理
# ================================================================
training:
  checkpoint_interval: 200
  keep_last_n: 5
  
  early_stopping:
    enabled: true
    patience: 500
    min_delta: 0.001
  
  logging:
    interval: 50
    tensorboard: false
    wandb: true
    wandb_project: "ems_ppo_normal"

# ================================================================
# 評価設定
# ================================================================
evaluation:
  interval: 100
  n_eval_episodes: 10
  compare_baselines: ["closest"]
  metrics:
    - "critical_6min_rate"
    - "achieved_13min_rate"
    - "mean_response_time"
    - "non_closest_selection_rate"

# ================================================================
# データ設定（本格学習用）
# ================================================================
data:
  data_paths:
    grid_mapping: "data/tokyo/processed/grid_mapping_res9.json"
    travel_time_matrix: "data/tokyo/calibration2/linear_calibrated_response.npy"
  
  episode_duration_hours: 24
  exclude_daytime_ambulances: true
  
  area_restriction:
    enabled: false
  
  # 本格学習期間（1ヶ月）
  train_periods:
    - start_date: "20230401"
      end_date: "20230430"
  
  # 評価期間（1週間）
  eval_periods:
    - start_date: "20230501"
      end_date: "20230507"

# ================================================================
# 傷病度設定
# ================================================================
severity:
  categories:
    critical:
      conditions: ["重症", "重篤", "死亡"]
      reward_weight: 1.0
    mild:
      conditions: ["軽症", "中等症"]
      reward_weight: 1.0
