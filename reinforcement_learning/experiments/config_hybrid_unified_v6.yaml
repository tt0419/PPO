# ================================================================
# config_hybrid_unified_v6.yaml
# カバレッジ計算を傷病度考慮運用と完全統一したハイブリッドPPO設定
# 
# 【重要な修正点】
# - coverage_sample_radius: 2 → 6（傷病度考慮運用と同じ）
# - sample_size/sample_points: 20（傷病度考慮運用と同じ）
# - 報酬重みはv4の値を維持（time=0.3, coverage=0.7）
# 
# 【背景】
# 傷病度考慮運用の実験経緯：
# - リング2: 重症RT改善、全体RT大幅悪化
# - リング6: 重症RT若干悪化、全体RT大幅改善
# PPOもリング6に統一することで、同じ土俵での比較が可能に
# ================================================================

# ベース設定を継承
inherits: ./config.yaml

# ================================================================
# 実験設定
# ================================================================
experiment:
  name: "hybrid_unified_v6"
  description: |
    ハイブリッドPPO v6: カバレッジ計算を傷病度考慮運用と完全統一
    
    【修正内容】
    1. coverage_sample_radius: 2 → 6（傷病度考慮運用と同じ）
    2. sample_size: 20（傷病度考慮運用と同じ、127セルから16%サンプリング）
    3. time_weight/coverage_weightはv4の値を維持（0.3/0.7）
    
    【背景】
    傷病度考慮運用の実験経緯：
    - リング2: 重症RT改善、全体RT大幅悪化（狭い視野）
    - リング6: 重症RT若干悪化、全体RT大幅改善（広域バランス）
    
    【期待される効果】
    - 傷病度考慮運用と同じ空間スケールでカバレッジを評価
    - 全体RTと重症RTのバランスが取れた学習
    - 直近隊選択率 40-60%程度を目標
  seed: 2025
  device: "cuda"

# ================================================================
# PPO設定
# ================================================================
ppo:
  n_episodes: 500  # 短期テスト用（元: 3000）
  batch_size: 512
  n_epochs: 4
  clip_epsilon: 0.1
  
  learning_rate:
    actor: 0.0003
    critic: 0.001
    scheduler: "constant"
  
  gamma: 0.99
  gae_lambda: 0.95
  entropy_coef: 0.035  # v4と同じ
  max_grad_norm: 0.5

# ================================================================
# 状態空間（46次元）
# ★★★ カバレッジ計算の修正 ★★★
# ================================================================
state_encoding:
  mode: 'compact'
  top_k: 10
  normalization:
    max_travel_time_minutes: 30
    max_station_distance_km: 10
  
  # ★★★ カバレッジ考慮型ソート設定（傷病度考慮運用と完全統一） ★★★
  coverage_aware_sorting:
    enabled: true
    time_weight: 0.6       # 傷病度考慮運用と同じ（ソート用）
    coverage_weight: 0.4   # 傷病度考慮運用と同じ（ソート用）
    sample_size: 20        # 傷病度考慮運用と同じ
    sample_radius: 6       # ★★★ 2 → 6（傷病度考慮運用と同じ）★★★
    pre_filter_size: 30
    use_adaptive_sampling: true
    max_candidates_for_advanced: 50

# ================================================================
# ハイブリッドモード
# ================================================================
hybrid_mode:
  enabled: true
  severity_classification:
    severe_conditions: ["重症", "重篤", "死亡"]
    mild_conditions: ["軽症", "中等症"]

# ================================================================
# 報酬設定（v4ベース + リング数統一）
# ================================================================
reward:
  system:
    dispatch_failure: -1.0
    no_available_ambulance: 0.0
  
  unified:
    critical_max_bonus: 50.0
    critical_lambda: 0.115
    critical_penalty_scale: 5.0
    critical_penalty_power: 1.5
    
    mild_max_bonus: 10.0
    mild_penalty_scale: 1.0
    
    coverage_w6: 1.0
    coverage_w13: 0.0
    coverage_penalty_scale: 35.0  # v4と同じ
    
    time_weight: 0.3       # v4と同じ
    coverage_weight: 0.7   # v4と同じ
  
  # ★★★ 報酬計算用カバレッジ設定（傷病度考慮運用と完全統一）★★★
  core:
    mild_params:
      sample_points: 20      # 傷病度考慮運用と同じ
      sample_radius: 6       # ★★★ 2 → 6（傷病度考慮運用と同じ）★★★
      coverage_6min_weight: 0.5
      coverage_13min_weight: 0.5

# ================================================================
# ネットワーク設定
# ================================================================
network:
  actor:
    hidden_layers: [128, 64]
    activation: "relu"
    dropout: 0.2
  
  critic:
    hidden_layers: [128, 64]
    activation: "relu"
    dropout: 0.2

# ================================================================
# 学習管理（チェックポイント活用）
# ================================================================
training:
  checkpoint_interval: 500
  keep_last_n: 7
  
  early_stopping:
    enabled: true
    patience: 500
    min_delta: 0.001
  
  logging:
    interval: 50
    tensorboard: false
    wandb: true
    wandb_project: "ems_ppo_hybrid_v6"

# ================================================================
# 評価設定
# ================================================================
evaluation:
  interval: 500
  n_eval_episodes: 10
  compare_baselines: ["closest"]
  metrics:
    - "critical_6min_rate"
    - "achieved_13min_rate"
    - "mean_response_time"
    - "non_closest_selection_rate"

# ================================================================
# データ設定
# ================================================================
data:
  data_paths:
    grid_mapping: "data/tokyo/processed/grid_mapping_res9.json"
    travel_time_matrix: "data/tokyo/calibration2/linear_calibrated_response.npy"
  
  episode_duration_hours: 24
  exclude_daytime_ambulances: true
  
  area_restriction:
    enabled: false
  
  train_periods:
    - start_date: "20230401"
      end_date: "20230430"
  
  eval_periods:
    - start_date: "20230501"
      end_date: "20230507"

# ================================================================
# 傷病度設定
# ================================================================
severity:
  categories:
    critical:
      conditions: ["重症", "重篤", "死亡"]
      reward_weight: 1.0
    mild:
      conditions: ["軽症", "中等症"]
      reward_weight: 1.0
