# ============================================================================
# 高件数期間特化モデル（夏・冬）
# ============================================================================
# 目標: 高件数期間で傷病度考慮に勝利
# 
# 設計方針:
# 1. 夏（7-8月）と冬（12-1月）の高件数期間に特化
# 2. 傷病度考慮との差が0.1分程度の条件で確実に勝つ
# 3. 高負荷時の効率的なリソース配分を学習
# 4. hybrid報酬で重症優先を明確化
# 
# 根拠:
# - 06-30期間: 傷病度考慮 8.99分 vs K20 9.10分（差0.11分）
# - 07-21期間: 傷病度考慮 10.48分 vs K20離散 10.57分（差0.09分）
# - 12-22期間: 傷病度考慮 10.81分 vs K20離散 11.05分（差0.24分）
# → 高件数期間では差が小さく、報酬強化で逆転の可能性
# 
# 期待される効果:
# - 高件数×低重症率（夏）: 傷病度考慮と同等または勝利
# - 高件数×高重症率（冬）: 傷病度考慮との差0.1分以下
# - 全体RT: 距離ベース以下を維持
# ============================================================================

curriculum:
  enabled: false
  stages: []

data:
  area_restriction:
    action_dim: 192
    area_name: 東京23区
    districts:
    - 千代田区
    - 中央区
    - 港区
    - 新宿区
    - 文京区
    - 台東区
    - 墨田区
    - 江東区
    - 品川区
    - 目黒区
    - 大田区
    - 世田谷区
    - 渋谷区
    - 中野区
    - 杉並区
    - 豊島区
    - 北区
    - 荒川区
    - 板橋区
    - 練馬区
    - 足立区
    - 葛飾区
    - 江戸川区
    enabled: true
    num_ambulances_in_area: 192
    section_code: null
    state_dim: 999
  data_paths:
    grid_mapping: data/tokyo/processed/grid_mapping_res9.json
    travel_time_matrix: data/tokyo/calibration2/linear_calibrated_response.npy
  episode_duration_hours: 24
  
  # 検証期間: 夏の高件数期間
  eval_periods:
  - end_date: '20230820'
    start_date: '20230806'
  
  exclude_daytime_ambulances: true
  max_steps_per_episode: 5000
  
  # 学習期間: 高件数期間に特化（夏・冬を重点的に）
  train_periods:
  # 冬1（高件数×高重症率）
  - end_date: '20230204'
    start_date: '20230108'
  # 夏1（高件数×低重症率）- メイン
  - end_date: '20230806'
    start_date: '20230702'
  # 夏2（高件数×低重症率）
  - end_date: '20230903'
    start_date: '20230820'
  # 冬2（高件数×高重症率）
  - end_date: '20231231'
    start_date: '20231203'

data_paths:
  grid_mapping: data/tokyo/processed/grid_mapping_res9.json
  travel_time_matrix: data/tokyo/calibration2/linear_calibrated_response.npy

evaluation:
  compare_baselines:
  - closest
  - severity_based
  interval: 100
  metrics:
  - severe_6min_rate
  - severe_mean_rt
  - critical_6min_rate
  - mild_13min_rate
  - mild_20min_rate
  - mild_mean_rt
  - overall_13min_rate
  - overall_mean_rt
  - coverage_score
  - workload_balance
  - vs_closest_improvement
  - dispatch_ratio
  n_eval_episodes: 5

experiment:
  description: 高件数期間特化モデル - 夏冬の高負荷時に傷病度考慮に勝利
  device: cuda
  name: high_demand_severe_priority_v1
  seed: 2025

hybrid_mode:
  coverage_evaluation:
    high_risk_weight: 0.6
    min_acceptable: 0.5    # やや緩和（高負荷対応）
    normal_weight: 0.4
  enabled: true
  penalties:
    over_warning: -150.0   # 大幅強化
    per_minute_over: -8.0  # 強化
  reward_weights:
    coverage: 0.15         # 削減（重症優先）
    response_time: 0.75    # 強化
    workload_balance: 0.1
  severity_classification:
    mild_conditions:
    - 軽症
    - 中等症
    severe_conditions:
    - 重症
    - 重篤
    - 死亡
  time_thresholds:
    good: 13
    warning: 20

inherits: ./config.yaml

network:
  actor:
    activation: relu
    dropout: 0.15          # やや増加（過学習防止）
    hidden_layers:
    - 512
    - 256
    - 128
    initialization: xavier_uniform
  critic:
    activation: relu
    dropout: 0.15
    hidden_layers:
    - 512
    - 256
    - 128
    init_scale: 0.001

ppo:
  batch_size: 2048
  clip_epsilon: 0.12       # やや小さく（安定性）
  entropy_coef: 0.008      # 削減（確実な収束）
  gae_lambda: 0.95
  gamma: 0.99
  learning_rate:
    actor: 0.00015         # 低め（慎重な学習）
    critic: 0.0006
    scheduler: constant
  max_grad_norm: 0.5
  n_episodes: 3000
  n_epochs: 12             # 増加（各バッチでより深く学習）

reward:
  core:
    continuous_params:
      critical:
        max_bonus: 400.0     # 4倍に強化
        penalty_scale: 40.0  # 4倍に強化
        target: 6
        weight: 4.0          # 重み4倍
      mild:
        max_bonus: 8.0
        penalty_scale: 0.4
        target: 13
        weight: 0.4
      moderate:
        max_bonus: 15.0
        penalty_scale: 1.5
        target: 13
        weight: 0.6
    coverage_impact_weight: 0.15
    discrete_params:
      penalties:
        over_13min: -25.0
        over_6min: -80.0     # 大幅強化
        per_minute_over: -8.0
      weights:
        coverage_preservation: 0.2
        response_time: 4.0   # 大幅強化
        severity_bonus: 8.0  # 大幅強化
    hybrid_params:
      balanced_workload_bonus: 5.0
      coverage_maintenance_bonus: 20.0
      good_coverage_bonus: 30.0
      mild_under_13min_bonus: 30.0
      moderate_under_13min_bonus: 100.0
      over_13min_penalty: -80.0
      over_20min_penalty: -250.0
      overloaded_penalty: -20.0
      poor_coverage_penalty: -30.0
      time_penalty_per_minute: -1.5
      # 重症専用の追加報酬（大幅強化）
      severe_under_6min_bonus: 800.0   # 強化
      severe_over_6min_penalty: -400.0 # 強化
    mode: hybrid
    simple_params:
      critical_under_6min_bonus: 150.0
      imitation_bonus: 0.0
      mild_under_13min_bonus: 3.0
      moderate_under_13min_bonus: 8.0
      over_13min_penalty: -8.0
      over_20min_penalty: -30.0
      time_penalty_per_minute: -0.8
  coverage_params:
    drop_penalty_threshold: 0.08   # やや緩和
    drop_penalty_weight: -8.0
    evaluation_interval: 100
    time_threshold_seconds: 360
  episode:
    achievement_bonuses:
      critical_6min_rate: 300.0    # 強化
      mild_13min_rate: 15.0
      mild_20min_rate: 8.0
      rate_13min: 8.0
      rate_6min: 80.0              # 強化
      severe_6min_rate: 250.0      # 強化
    base_penalty_per_minute: -0.8
    failure_penalty_per_incident: -3.0
  system:
    dispatch_failure: -3.0
    no_available_ambulance: 0.0
    unhandled_call_penalty: -3.0

reward_mode:
  mode: hybrid

severity:
  categories:
    critical:
      conditions:
      - 重症
      - 重篤
      - 死亡
      reward_weight: 4.0     # 大幅強化
      time_limit_seconds: 360
    mild:
      conditions:
      - 軽症
      reward_weight: 0.4
      time_limit_seconds: 780
    moderate:
      conditions:
      - 中等症
      reward_weight: 0.6
      time_limit_seconds: 780
  thresholds:
    golden_time: 360
    standard_time: 780

state_encoding:
  mode: compact
  normalization:
    max_station_distance_km: 10
    max_travel_time_minutes: 30
  top_k: 20

teacher:
  apply_to:
  - 軽症
  - 中等症
  decay_episodes: 1500
  enabled: false
  final_prob: 0.0
  initial_prob: 0.0
  strategy: closest

training:
  checkpoint_interval: 150
  early_stopping:
    enabled: true
    metric: severe_mean_rt
    min_delta: 0.005       # より細かく監視
    mode: min
    patience: 350
  keep_last_n: 5
  logging:
    hybrid_logs:
    - severe_dispatch_count
    - mild_dispatch_count
    - coverage_history
    - warning_episodes
    - continuous_reward_components
    interval: 10
    tensorboard: true
    wandb: true
    wandb_project: ems_high_demand_priority
